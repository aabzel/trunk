\graphicspath{ {PATH_FW_LOADER_REPORT_DIR/pix} }


\chapter{DeskTop утилита FW Loader}


\section{Пролог}

Данный текст является пояснительной запиской для Windows DeskTop PC утилиты FW loader.
Также в тексте представлено техническое задание на разработку утилиты loader.
Утилита FW loader  предназначена, чтобы загрузать прошивку в SPIFI память микроконтроллера через 
on-chip загрузчик в EEPROM памяти MIK32.


\section{Определения}

\begin{enumerate}

  \item Алгоритм - посделовательность действий.

  \item Программа - алгоритм написанный на языке программирования.

  \item Процесс - исполняемый экземпляр программы в памяти.
 
 
   \item Модульный тест - функция, которая вызывает другую функцию с известными 
        аргументами и проверяет наличие ожидаемого результата.  
        В случае противоречия сигнализирует об ошибке. 
          
          
    \item Прошивка (firmware) - содержимое энергонезависимой памяти электронного 
     устройства с микроконтроллером. В прошивке всегда есть код, а иногда ещё образ 
     файловой системы NVRAM, конфиги процессора. 
     Монолитная прошивка может содержать ещё и загрузчик. 

    \item Загрузчик - это отдельная прошивка, которая загружает другую прошивку. 
     Обычно загрузчик стартует сразу после подачи питания перед запуском приложения. 
     Это чисто системная часть кода.
 
 
    \item Компилятор - это консольная программа преобразующая исходный код в машинный, 
       который затем может быть выполнен процессором или другой программой (виртуальной машиной).
       
    \item CLI - Интерфейс командной строки. 
              Это способ взаимодействовать с программой обменом текстами по принципу запрос-ответ.
              
    \item  connectivity - всё что связано с интерфейсами и протоколами.
    
\end{enumerate}



\section{Что надо из оборудования?}

\begin{enumerate}
    \item Учебно-тренировочная электронная отладочная плата START-MIK32-V1. 1 шт.
    \item Кабель USB-A на USB micro. 1 штук.
    \item Переходник с USB на UART на ASIC CP2102. 1 шт. (необязательно)
    \item Перемычки гнездо-гнездо. 4+ штук. (необязательно)
\end{enumerate}


INSERT_PIX2(Mik32Bootloader, Схема подключения платы для перепрошивки)

\section{Что надо из ПО?}

\begin{enumerate}
    \item  Операционная система Windows 10.
    \item  Компилятор MinGW gcc.exe.
    \item  Утилита системы сборки GNU Make.
    \item  WinRar. Чтобы распаковать программы перед установкой (terminal 1.9b).

    \item  Программа terminal 1.9b. 
           Для отладки системы поманд на стороне прошивки.

    \item  Консольная утилита FW\_Loader.exe.
\end{enumerate}



\section{Обязательные технические требования}

Общий план таков, что надо загрузить прошивку в off-chip SPI памяти при помощи 
on-chip MIK32 загрузчиком и утилиты FW\_Loader по UART0.
То есть обновить прошивку без программатора.


\begin{enumerate}
    \item Программа FW\_Loader должна быть собрана для OS Windows

    \item Программа FW\_Loader должна обладать своей собственной системой команд.

      \item  Все команды должны вызываться, как в интерактивном режиме, так и в пакетном режиме.

    \item Аргументы командной строки должны быть позиционными.
          Самый главные аргументы вначеле. 
          Вспомогательные аргументы в конце.
          Это наиболее простой и быстрый способ для реализации в коде.
          Для этого уже есть весь код.

    \item Программа FW\_Loader должна быть собрана на языке программирования Си.
          Это позволит переиспользовать исходный код между прошивкой и PC процессом.

    \item  Утилита FW\_Loader должна уметь проверять нынешнее содержимое 
           прошивки в SPIFI памяти с указанным *.hex файлом.

    \item  Утилита FW\_Loader должна быть консольным приложением.

    \item  В утилите FW\_Loader должна быть команда ping для проверки соединения между PC и платой.

    \item Программа FW\_Loader должна работать с hex файлом

    \item Программа FW\_Loader должна позволять конфигурировать паузу 
          между отправкой байтов в COM порт аргументами командной строки.
          Это нужно, чтобы загрузчик не захлебнулся от интенсивного потока входных байт.

    \item Программа FW\_Loader должна входить в интерактивный режим только в случае запуска без аргументов 
          командной строки. 
          В случае запуска с аргументами командной строки утилита только отрабатывает свои 
          ключи и автоматически выходит, возвращая код ошибки.
          То есть приложение  FW\_Loader должно быть пригодно для запуска из другого приложения и 
          сообщать ему простым в использовании способом о возникновении проблемы.

    \item Программа FW\_Loader должна возвращать код ошибки в случае неудачного подключения и прошивки.
    
    \item Программа FW\_Loader должна собираться из скрипта сборки .
          Это позволит подключить её к серверу сборки Jenkins.

    \item Программа FW\_Loader должна быть отднопоточным процессом в операционной системе.

    \item Программа FW\_Loader должна собираться из скриптов сборки GNU Make.
 
    \item Программа FW\_Loader должна содержать модульные тесты.
    
    \item Битовая скорость UART должна передаваться через ключи утилиты.

     \item  После обновления утилита должна давать команду прыжка в приложение.

     \item У каждой CLI команды утититы FW\_Loader должна быть справка.
           Справку можно изучить в интеррактивном режиме работы утилиты буквально набрав название команды.

    \item Утилита должна записывать прошивку по частям. 

    \item У утилиты FW Loader должен быть интеррактивный режим.
          То есть режим командной строки в stdio.
          Подобно тому, как это происходит в программе BusyBox.
    
    \item У утилиты FW Loader должен быть пакетный режим.
          То есть утилита должна отрабатывать свои аргументы командной строки.

     \item Должна быть предусмотрена возможность вычитывать содержимое физической памяти MCU.
     
     
    \item Пауза между отправкой байтов должна передаваться через командную строку, как аргумент команды.
     
 \item  FW Loader - это консольное Windows приложение (FW\_Loader.exe) под Windows 10 PC для 
     нарезания *.hex фйла и отправки фрагментов прошивки по последовательному COM порту.

 \item Вот так должна выглядеть команда обновления прошивки через COM порт 4 на битовой скорости 56000 bit/s
      
        \begin{lstlisting}[label=some-code,caption=]
            FW_Loader.exe fwll start_mik32_v1_generic_gcc_m.hex COM4 56000 10
        \end{lstlisting}

\end{enumerate}



\section{Желательные технические требования }

\begin{enumerate}

    \item Желательно, чтобы программа FW\_Loader была так же собрана для OS Linux.
          Сборка утилиты FW-Loader на Linux - это отдельная большая задача.
          В Linux другой API для работы с COM поротом и надо отдельно настраивать 
          ToolChain для разработки под Linux.
          Нужно хотя бы постараться сделать меньше вещей, зависящих от платформы.


     \item  Желательно, чтобы  приложение FW\_Loader позволяло сбрасывать микроконтроллер.
            В случае с платой START-MIK32-V1 устанавлитьвать 0V и 3.3V на 
            пине U4.12 микроконтроллера CH552T.

     \item  Желательно, чтобы микроконтроллерное приложение само поддерживало протокол TBFP.
            Чтобы утилита FW\_Loader могла дать команду прыгнуть из приложения в загрузчик 
            для начала процесса обновления.

     \item  Желательно сделать аргументы командной строки именованными, а не позиционными.
\end{enumerate}



\section{Структура программы FW Loader}

Предполагается, что утилита FW\_Loader состоит из следующих программных компонентов:

\begin{enumerate}
    \item  Подсистема файлового ввода-вывода.
    \item  Синтаксический анализитор HEX файлов.
    \item  Драйвер последователього порта (COM порта). 
    \item  Программный компонент FW-Loader. 
    \item  Бинарный протокол передачи данных Trivial Binary Frame Protocol (TBFP).
    \item  Простой кооперативный планировщик. По сути - суперцикл.
    \item  Программный компонент FIFO.
    \item  Программный компонент CLI (с конфигом в stdin/stdout).
    \item  Программный компонент CRC8. 
          
\end{enumerate}







\section{Механизм обновления}

Обновление прошивки происходит через последовательный COM порт при битовой скорости 56000 бит/c.
Параметры кадра: два стоповых бита,
нет проверки четности,
один кадр - 8 бит.

Сеанс связи показан на временной диаграмме процесса обновления прошивки.
Перед обновлением необходимо отправить TBFP пакет стирания содержимого микросхемы W25Q32JV.

INSERT_PIX2(DFU_dialog.jpg, сеанс связи)

После обновления можно принудительно прыгнуть исполнять код по адресу 0x80000000 отправив в UART0 пакет
A5 C1 01 00 04 00 01 00 00 00 80 E4




\section{Отладка бинарного протокола}

Сам протокол TBFP отлажен в составе консольного Windows PC приложения.
На это есть модульные тесты. 
В частрости на чтение и запись по протоколу TBFP.

\begin{lstlisting}[label=some-code,caption=Тесты протокола TBFP]

-->
-->tsa tbfp_storage+
tbfp_storage_read.153
tbfp_storage_write.154
-->tsr tbfp_storage_read
-->tsr tbfp_storage_write
 
\end{lstlisting} 

Консольная Win утилита также умеет генерировать тестировочные TBFP пакеты,
чтобы не набирать их вручную.

\begin{lstlisting}[label=some-code,caption=CLI утилита для формирования пакетов]

Erase all contents of the SPI memory chip
-->tseg  
 StoreEraseFrame:
 A5C101000800FC000000000000030123
 A5C101000800FC 00000000 0000 03 01 23
 
 Insert for the program  terminal 1.9b: Erase all SPI memory chip

$A5$C1$01$00$08$00$FC$00$00$00$00$00$00$03$01$23
 



Generate a packet to read from the address (tsrg):
Usage: tsrg addr size
-->tsrg 0x00000000 16

Insert for the program  terminal 1.9b: read 0x00000000  16 byte
$A5$81$01$00$08$00$FC$00$00$00$00$10$00$01$01$59

$A5$81$01$00$08$00$FC$00$F0$01$00$40$00$01$01$07

$A5$81$01$00$08$00$FC$00$E0$03$00$20$00$01$01$EC

------------------------
Let's try to write something down
Usage: tswg addr size pattern
-->tswg 0x00000000 8 0x77 

Insert for the program  terminal 1.9b:  write 0x77 down at 0x00000000
$A5$C1$01$00$10$00$FC$00$00$00$00$08$00$02$01$77$77$77$77$77$77$77$77$29


-->tswg 16 8 0x33
88 I,[TBFP] Address:0x00000010,Size:8,Pattern:0x33
89 I,[TBFP] N:1,PRE:0xa5,IF:Stdio,RxMem:0047b8e0,RxSz:512,UART:85,SN:0,PrevFlow:0,CurFlow:0,MaxFlow:0,TornCnt:0,Lost:0,
90 I,[TBFP] PayLoadLen:16 byte
91 I,[TBFP] StoreWriteFrame:A5C101001000FC100000000800020133333333333333337A

 Insert for the program  terminal 1.9b:
$A5$C1$01$00$10$00$FC$10$00$00$00$08$00$02$01$33$33$33$33$33$33$33$33$7A


Generate a packet to read from the address (tsrg):
tsrg 32 16

 Insert for the program  terminal 1.9b: read
$A5$81$01$00$08$00$FC$20$00$00$00$10$00$01$01$76


-------------------------------
-->tgj 0x80000000
W,[TBFP] GenerateJumpToAddr:0x80000000 Packet
I,[TBFP] N:1,PRE:0xa5,IF:Stdio,RxMem:0047b8e0,RxSz:512,UART:85,SN:0,PrevFlow:0,CurFlow:0,MaxFlow:0,TornCnt:0,Lost:0,
I,[TBFP] PayLoadSize:4 byte
I,[TBFP] JumpFrame: A5C1010004000100000080E4
A5C10100040001 00000080 E4

Insert for the program  terminal 1.9b: jump to addr: 0x80000000
$A5$C1$01$00$04$00$01$00$00$00$80$E4



\end{lstlisting} 

Эти пакеты с символом доллара предназначены для вставки в программу Terminal 1.9b.







\section{Итог}


Утилита находится в разработке.


\section{Акронимы}

\begin{tabular} {ll}
    Акроним & Расшифровка \\
    \hline
    FW &  FirmWare \\
    OS &  Operation System \\
    DFU  &  device firmware update \\
    SPI  &  Serial Peripheral Interface \\
    SPIFI &  Serial Peripheral Interface Flash Interface \\
    UART &  universal asynchronous receiver-transmitter \\
    KA &  Конечный Aвтомат \\
    TBFP  & Trivial Binary Frame Protocol \\
    CRC &  Cyclic redundancy check \\
    RAM &  Random Access Memory \\
\end{tabular}





\section{Гиперссылки}

\begin{enumerate}
  \item \href{ https://github.com/aabzel/trunk/tree/main/source/projects/fw_loader}{Исходный код FW Loader}
  \item \href{https://microsin.net/programming/pc/intel-hex-file-format.html}{Intel HEX: описание формата файла}
  \item \href{https://habr.com/ru/articles/754972/}{Как собрать Си программу в OS Windows}
  \item \href{https://habr.com/ru/companies/ruvds/articles/574352/}{Осваиваем LaTeX за 30 минут}

  \item \href{https://github.com/aabzel/trunk/tree/main/source/projects/start_mik32_v1_eeprom_bootloader_m}{Исходный код EEPROM загрузчика}
  \item \href{https://habr.com/ru/articles/682292/}{Атрибуты Хорошего Канального Протокола Передачи Данных}
  \item \href{https://habr.com/ru/articles/754216/}{Атрибуты Хорошего Загрузчика}
  \item \href{https://habr.com/ru/sandbox/30635/}{Работа с последовательным портом в windows и linux}
  \item \href{https://habr.com/ru/companies/rainbow/articles/275381/}{Удаленное обновление прошивки микроконтроллера}
  \item \href{https://microtechnics.ru/mikrokontroller-i-bootloader-opisanie-i-princip-raboty/}{Микроконтроллер и Bootloader. Описание и принцип работы.}

\end{enumerate}



\section{Контрольные вопросы  }

\begin{enumerate}
  \item  Зачем нужен загрузчик во встраиваемых системах? 
         Назовите минимум 3 его функции.
         
  \item  Как загрузчик может обмениваться данными с приложением?

  \item  Как защитить микроконтроллер от загрузки чужеродного кода через загрузчик?
  
  \item  Как загрузчику понять, что загрузчик принял в самом деле прошивку, а не 
         набор случайных циферок с правильной CRC?
         
  \item  Вам прислали прошивки в *.bin файле. 
         Как загрузить и запустить эту прошивку по произвольному отступу в on-chip Nor Flash памяти?
\end{enumerate}


\section{Приложения }




