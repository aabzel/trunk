\graphicspath{ {PATH_MIK32_BOOTLOADER_REPORT_DIR/pix} }


\chapter{SPIFI Загрузчик для MIK32}

\section{Пролог}

Данный текст является пояснительной запиской про SPIFI загрузчик для микроконтроллера 
MIK32(K1948BK018).

Надо обновить EEPROM прошивку MIK32 загрузчиком.
То есть без программатора.
В случае с MIK32 cамый достпупный интерфейс это UART.
Микроконтроллер поддерживат два UART трансивера: UART0 и UART1.

Главная задача хорошего загрузчика - это дать возможность обновлять прошивку и ни при 
каких обстоятельствах не позволить устройству зависнуть.


\section{Определения}

\begin{enumerate}

    \item прошивка (firmware) - содержимое энергонезависимой памяти электронного 
     устройства с микроконтроллером. В прошивке всегда есть код, а иногда ещё образ 
     файловой системы NVRAM, конфиги процессора. Монолитная прошивка может содержать 
     еще и загрузчик. 

    \item  загрузчик - это отдельная прошивка, которая загружает другую прошивку. 
     Обычно загрузчик стартует сразу после подачи питания перед запуском приложения. 
     Это чисто системная часть кода.

     \item NVRAM - энергонезависимая память с произвольным доступом. 
      По сути Key-Val-Map(ка). 
      В ней могут храниться любые бинарные данные, ассоциированные со своим ID(шником).

\end{enumerate}


\section{Что надо из оборудования?}

\begin{enumerate}
    \item Учебно-тренировочная электронная плата отладочная плата START-MIK32-V1. 1 шт.
    \item Переходник с USB на UART на ASIC CP2102. 1 шт.
    \item Кабель USB-A на USB micro. 1 штук.
    \item Перемычки гнездо-гнездо. 4+ штук.
\end{enumerate}


INSERT_PIX2(ConRule, Схема подключения платы для перепрошивки)



\section{Что надо из ПО?}

\begin{enumerate}
    \item  Операционная система Windows 10.
    \item  Программа TeraTerm.
    \item  Консольная утилита FW-loader.exe .
\end{enumerate}




\section{Постановка задачи}

Данные требования к загрузчику были предложены непосредственно разработчиком.

\begin{enumerate}
    \item  Загрузчик должен быть однопоточной NoRTOS прошивкой. 
	Так можно уменьшить *.bin(арь) и упростить код загрузчика. 
 
    \item Загрузчик должен записывать прошивку по частям. 
    Перед записью фрагмента проверять контрольную сумму принятого куска памяти. 
	
	\item Вся прошивка тоже должна быть защищена контрольной суммой.
	Если CRC32 не cовпадает, то такую прошивку лучше не запускать. 
	Правильная CRC это всего лишь гарантия, что прошивка, как файл передалась корректно. 
	
	\item Загрузчик должен уметь прошивать как минимум по UART. 
	Когда всё сломается пере прошивка по UART окажется единственным выходом. 
	Нет проводного интерфейса проще UART. 
	Для UART много дешевых переходников USB-UART и бесплатного софта для serial портов типа 
	Putty и TeraTerm.

	\item В загрузчике должна быть NVRAM. 
	Это позволит передавать команды от приложения к загрузчику. 
	Или сервер может прописать в NVRAM правильную контрольную сумму для того, чтобы 
	загрузчик мог рассчитать CRC и сверить с тем, что прописал сервер в NVRAM. 
	В случае несовпадения отказаться загружать подозрительную прошивку. 
 
	\item Перед прыжком в приложение загрузчик должен отключить все прерывания. 
	Иначе программа приложения зависнет, если в ней сработает прерывание для 
	которого в приложении нет функции обработчика. 
	
	\item Отключить системный таймер, так как в приложении может быть RTOS. 
	Если сработает прерывания по таймеру до инициализации планировщика, то 
	приложение с RTOS зависнет.
	
	\item  У загрузчика должна быть UART-CLI. 
	Это позволит подключиться к консоли загрузчика и проверить диагностику, прописывать NVRAM. 
	Протокол CLI - текстовый. 
	Его понимает и человек и утилита. 
	Через CLI можно обновить прошивку .
	
	\item Если загрузчику не удалось запустить прошивку из энергонезависимого Flash хранилища 
	(EEPROM, off-chip SPI-flash или on-chip flash), то загрузчик должен написать про это красный 
	текст в UART-CLI и перейти в режим ожидания прошивки по UART.

	\item Когда стартует загрузчик или приложение прошивка должна увеличивать 
	счётчик запусков BootCnt. 
	Если счетчик запусков превысит число N (например N=5), то загрузчик 
	прикажет сам себе остаться в загрузчике. 
	Приложение же должно обнулять счетчик запусков BootCnt после успешной инициализации или, например, на 
	30й секунде своей работы. 
	Это своего рода защита от тыквы (зависания в инициализации приложения). 
	Если залили приложение, которое из-за исключения постоянно reset(тится) 
	где-то в инициализации, то такое приложение после N reset(тов) автоматически 
	свалится в загрузчик и можно будет спокойно 
	записать по UART нормальную прошивку для ремонта.
	
	\item Перед прыжком в прложение загрузчик должен отключить прерывания. 
	Вероятно, что в приложении не будет реализации обработчиков прерываний.
	Например прошивка такого приложения может зависнуть от приёма байта в UART.
	Если приложению и нужны эти самые прерывания, то приложение само их включит по мере надобности.

	\item Загрузчик это не только еще одна прошивка в репозитории. 
     Для загрузчика нужна инфраструктура и экосистема. 
     В самом простом виде это консольное Win приложение (FW Loader) под PC для 
     отправки прошивки по serial COM порту.

	\item Сам загрузчик записывать программатором по JTAG.
	
\end{enumerate}


\section{Структура загрузчика}

Данный загрузчик обладает стедующими программными компонентами:
\begin{enumerate}
    \item  Интерфейс командной строки (UART-CLI)
    \item  Программный компонент разбора CSV строк
    \item  NVRAM
    \item  Драйвер EEPROM
    \item  Кооперативный планировщик
    \item  Драйвер UART трансивера 
    \item  Программный компонент CRC
\end{enumerate}








\section{Команды загрузчика}

В прошивке загрузчика запущен интерфейс командной строки поверх UART.

INSERT_PIX2(vi, UART-CLI загрузчика)

Загрузчику можно давать команды, как из UART-CLI, так и через переменные NVRAM.
Обновление прошивки тоже предполагается через CLI.


\begin{tabular} {lll}
    VariableName & NVRAM ID & \\
    \hline
    StartApp & 11 &   Адрес по которому лежит загружаемая прошивка \\
    BootCmd  & 12 &   Команда загрузчку \\
\end{tabular}

Команда загрузчку обладает следующими опциями:

\begin{tabular} {lll}
    Команда загрузчку &   ID & \\
    \hline
    STAY\_ON & 1  & остаться в загрузчике\\
    LAUNCH\_APP & 2 &  запустить приложение \\
    LAUNCH\_APP\_CRC & 3 & запустить приложение, если совпала CRC \\
\end{tabular}

Чтобы приказать загрузчику загружать прошивку без проверки CRC надо выполнить в консоли команду


\begin{lstlisting}[label=some-code,caption=загружать прошивку без проверки CRC]
ps 12 2
\end{lstlisting}

Чтобы остаться в загрузчике надо выполнить в консоли команду:

\begin{lstlisting}[label=some-code,caption=Остаться в загрузчике]
ps 12 1
\end{lstlisting}

Чтобы приказать загрузчику стартовать по адресу EEPROM надо исполнить команду: 

\begin{lstlisting}[label=some-code,caption=стартовать по адресу EEPROM]
ps 11 0x01000000
\end{lstlisting}

Всё это можно произвести одной CLI командой.
Инициировать запуск приложения из EEPROM можно командой mile. 




\section{Механизм обновления}

Обновление прошивки предполагается через текстовый протокол UART консоли.
Непосредственно запись самой прошивки должна производиться по частям при помощи 
CLI команд eeprom\_write\_relative. 
Проверить записанный диапазон можно командой eeprom\_read\_relative.


\begin{lstlisting}[label=some-code,caption=UART-CLI команды для EEPROM]
+-----+----------+-----------------------+-----------------------------+
| Num | Acronym  |     CommandName       | Description                 |
+-----+----------+-----------------------+-----------------------------+
|   1 |      err | eeprom_read_relative  | Eeprom Read Ralative   
|   2 |      ewr | eeprom_write_relative | Eeprom Write Ralative
|   3 |      brb |          boot_reboot  | Boot Re Boot
|   4 |     mile |  mik32_launch_eeprom  | Mik32 Launch From Eeprom
+-----+----------+-----------------------+-----------------------------+

Usage: eeprom_read_relative offdet size 
       eeprom_write_relative offset data crc32

\end{lstlisting}
 
Команды с суфиксом relative работают с выровненными адресами для DWORDов.
То есть 0,4,8,...4*N (где N-натуральное число).















\section{Пояснения к Си-коду загрузчика}

Чтобы запустить на исполнене приложение надо исполнить ассемблерную команду.
la ra, 0x01000000 
загрузить адрес 0x01000000 в регистр ra (return address). 
Он же x1.
Далее jalr уйти по регистру и сохранить адрес возврата.


\begin{lstlisting}[label=some-code,caption=Прыжок в EEPROM]
   __asm__ volatile(    "la ra, 0x01000000\n\t"      \
                        "jalr ra"                   \
                   );
\end{lstlisting}	






\section{ Достоинства загрузчика}

\begin{enumerate}
 
    \item Загрузчиком можно обновлять прошивку без программатора.

    \item Когда есть загрузчик, то можно делать DevOps. 
	      Автоматически обновлять прошивки после сборки из репозитория.
	
 
\end{enumerate}






\section{Итог}

Удалось составить загрузчик, который обладает набором команд для 
загрузки прошивки в on-chip EEPROM. 
Сам загрузчик исполняется из SPIFI.
То есть из off-chip NOR Flash памяти.




\section{Акронимы}

\begin{tabular} {ll}
    Акроним & Расшифровка \\
    \hline
    SPI &  Serial Peripheral Interface \\
    SPIFI &  Serial Peripheral Interface Flash Interface \\
    NVRAM & Non-volatile random-access memory \\
    FW &  FirmWare \\
    UART &  universal asynchronous receiver-transmitter \\
    ISR &  Interrupt Service Routine \\
    CRC &  Cyclic redundancy check \\
    RAM &  Random Access Memory \\
    RISC-V & Reduced instruction set computer V \\
\end{tabular}







\section{Гиперссылки}

\begin{enumerate}
  \item \href{https://habr.com/ru/articles/754216/}{23 Атрибута Хорошего Загрузчика}
  \item \href{https://habr.com/ru/articles/706972/}{NVRAM для микроконтроллеров}
  \item \href{https://habr.com/ru/articles/815639/}{NVRAM из EEPROM}
  \item \href{https://habr.com/ru/companies/rainbow/articles/275381/}{Удаленное обновление прошивки микроконтроллера}
  \item \href{https://microtechnics.ru/mikrokontroller-i-bootloader-opisanie-i-princip-raboty/}{Микроконтроллер и Bootloader. Описание и принцип работы.}

\end{enumerate}







\section{Контрольные вопросы  }


\begin{enumerate}
  \item  Зачем нужен загрузчик во встраиваемых системах? Назовите минимум 3 его функции.
  \item  Как загрузчик может обмениваться данными с приложением?
  \item  В чем опасность вызова функций загрузчика из приложения? 
  \item  Как защитить микроконтроллер от загрузки чужеродного кода через загрузчик?
  \item  Как загрузчику понять, что загрузчик принял в самом деле прошивку, а не набор случайных циферок с правильной CRC?
\end{enumerate}



